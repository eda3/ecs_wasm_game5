// src/component.rs

// Rust ã® Any å‹ã‚’ä½¿ã†ãŸã‚ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚ˆã€‚
// ã“ã‚Œã‚’ä½¿ã†ã¨ã€å…·ä½“çš„ãªå‹ãŒåˆ†ã‹ã‚‰ãªãã¦ã‚‚ã€å‹æƒ…å ±ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã‚“ã ï¼
// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ç®¡ç†ã™ã‚‹æ™‚ã«ã¡ã‚‡ã£ã¨å½¹ç«‹ã¤ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã ã‚ˆã€‚(å¾Œã§ä½¿ã†ã‹ã‚‚ï¼ŸğŸ¤”)
use std::any::Any;
// HashMap ã‚’ä½¿ã†ãŸã‚ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã‚’åŠ¹ç‡çš„ã«æ ¼ç´ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã ã‚ˆã€‚
// Entity ID ã‚’ã‚­ãƒ¼ã«ã—ã¦ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å€¤ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã®ã«ãƒ”ãƒƒã‚¿ãƒªï¼ğŸ‘
use std::collections::HashMap;

// ã•ã£ãä½œã£ãŸ Entity å‹ã‚’ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ä½¿ã†ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚ˆã€‚
use crate::entity::Entity; // `crate::` ã¯ã€ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã‚¯ãƒ¬ãƒ¼ãƒˆï¼‰ã®ãƒ«ãƒ¼ãƒˆã‹ã‚‰è¦‹ãŸãƒ‘ã‚¹ã£ã¦æ„å‘³ã ã‚ˆã€‚

/// Componentï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰ãƒˆãƒ¬ã‚¤ãƒˆã ã‚ˆï¼
///
/// ãƒˆãƒ¬ã‚¤ãƒˆã£ã¦ã„ã†ã®ã¯ã€ç‰¹å®šã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®ã€Œå¥‘ç´„ã€ã¿ãŸã„ãªã‚‚ã®ã ã‚ˆã€‚
/// ã“ã® `Component` ãƒˆãƒ¬ã‚¤ãƒˆã¯ã€æ§‹é€ ä½“ãŒã‚²ãƒ¼ãƒ ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦
/// ä½¿ã‚ã‚Œã‚‹è³‡æ ¼ãŒã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒãƒ¼ã‚«ãƒ¼ï¼ˆç›®å°ï¼‰ã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ã‚“ã ã€‚
///
/// ä»Šã¯ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå…·ä½“çš„ãªæ©Ÿèƒ½ï¼‰ã¯ä½•ã‚‚ãªã„ã‘ã©ã€å°†æ¥çš„ã«å…±é€šã®å‡¦ç†ãŒå¿…è¦ã«ãªã£ãŸã‚‰ã€
/// ã“ã“ã«è¿½åŠ ã§ãã‚‹ã‚ˆï¼æ‹¡å¼µæ€§ãŒã‚ã‚‹ã£ã¦ã“ã¨ã ã­ï¼ğŸš€
///
/// `Send + Sync + 'static` ã£ã¦ã„ã†ã®ã¯ã€ã¡ã‚‡ã£ã¨é›£ã—ã„ã‘ã©ã€
/// ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆè¤‡æ•°ã®å‡¦ç†ã‚’åŒæ™‚ã«å‹•ã‹ã™ï¼‰ç’°å¢ƒã§ã‚‚å®‰å…¨ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®åˆ¶ç´„ã ã‚ˆã€‚
/// `'static` ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œä¸­ãšã£ã¨å­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚ˆã€‚
/// ã“ã‚Œã‚‰ã‚’ä»˜ã‘ã¦ãŠãã¨ã€å¾Œã§å›°ã‚‹ã“ã¨ãŒå°‘ãªããªã‚‹ã‚“ã ï¼ğŸ˜Œ
pub trait Component: Send + Sync + 'static {
    // å°†æ¥ã€å…¨ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å…±é€šã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒå¿…è¦ã«ãªã£ãŸã‚‰ã€ã“ã“ã«è¿½åŠ ã§ãã‚‹ã‚ˆï¼
    // ä¾‹ãˆã°ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹æ©Ÿèƒ½ã¨ã‹ï¼ŸğŸ¤”
    // fn reset(&mut self);
}

/// ComponentStorageï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰ã ã‚ˆï¼
///
/// ã“ã‚Œã¯ã€ç‰¹å®šã®ç¨®é¡ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆä¾‹ãˆã° Position ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã‹ï¼‰ã‚’
/// ãŸãã•ã‚“ã¾ã¨ã‚ã¦ä¿å­˜ã—ã¦ãŠããŸã‚ã®ç®±ã¿ãŸã„ãªã‚‚ã®ã ã‚ˆã€‚ğŸ“¦
///
/// `HashMap<Entity, T>` ã‚’ä½¿ã£ã¦ã‚‹ã®ã¯ã€
/// - ã‚­ãƒ¼: `Entity` (ã©ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚’ç¤ºã™ID)
/// - å€¤: `T` (å®Ÿéš›ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã€‚`T` ã¯ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã§ã€Position ã¨ã‹ Card ã¨ã‹ã€è‰²ã€…ãªå‹ãŒå…¥ã‚‹ã‚ˆï¼)
/// ã“ã†ã™ã‚‹ã“ã¨ã§ã€ã€Œã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£IDãŒ X ã® Position ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã“ã‚Œï¼ã€ã¿ãŸã„ã«ã€
/// ç´ æ—©ããƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã›ã‚‹ã‚“ã ï¼âš¡ï¸
///
/// `T: Component` ã£ã¦ã„ã†ã®ã¯ã€ã€Œã“ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å…¥ã‚Œã‚‰ã‚Œã‚‹å‹ `T` ã¯ã€
/// å¿…ãš `Component` ãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…ã—ã¦ãªã„ã¨ã„ã‘ãªã„ã‚ˆï¼ã€ã£ã¦ã„ã†åˆ¶ç´„ã ã‚ˆã€‚
/// ã“ã‚Œã§ã€é–¢ä¿‚ãªã„ãƒ‡ãƒ¼ã‚¿ãŒç´›ã‚Œè¾¼ã¾ãªã„ã‚ˆã†ã«ã—ã¦ã‚‹ã‚“ã ã€‚è³¢ã„ï¼ğŸ˜
#[derive(Debug)] // ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚ˆï¼
pub struct ComponentStorage<T: Component> {
    // `components` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ HashMap ã ã‚ˆã€‚
    components: HashMap<Entity, T>,
}

// ComponentStorage ã®å®Ÿè£…ãƒ–ãƒ­ãƒƒã‚¯ã ã‚ˆï¼
// ã“ã“ã«ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆé–¢æ•°ï¼‰ã‚’å®šç¾©ã—ã¦ã„ãã‚ˆã€‚
impl<T: Component> ComponentStorage<T> {
    /// æ–°ã—ã„ç©ºã® ComponentStorage ã‚’ä½œã‚‹ã‚ˆï¼
    pub fn new() -> Self {
        Self {
            components: HashMap::new(), // ç©ºã® HashMap ã§åˆæœŸåŒ–ï¼
        }
    }

    /// ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ ãƒ»æ›´æ–°ã™ã‚‹ã‚ˆï¼
    ///
    /// ã‚‚ã— `entity` ãŒæ—¢ã«ã“ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒã£ã¦ã„ãŸã‚‰ã€
    /// æ–°ã—ã„ `component` ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ã‚ˆã€‚
    ///
    /// # å¼•æ•°
    /// - `entity`: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ ã—ãŸã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ID
    /// - `component`: è¿½åŠ ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿
    pub fn insert(&mut self, entity: Entity, component: T) {
        // HashMap ã® insert ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã ã‘ï¼ç°¡å˜ï¼ğŸ˜Š
        self.components.insert(entity, component);
    }

    /// ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ã‚ˆï¼(èª­ã¿å–ã‚Šå°‚ç”¨)
    ///
    /// # å¼•æ•°
    /// - `entity`: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å–å¾—ã—ãŸã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ID
    ///
    /// # æˆ»ã‚Šå€¤
    /// - `Some(&T)`: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒã£ã¦ã„ã‚Œã°ã€ãã®å‚ç…§ã‚’è¿”ã™ã‚ˆã€‚
    /// - `None`: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒã£ã¦ã„ãªã‘ã‚Œã°ã€None ã‚’è¿”ã™ã‚ˆã€‚
    ///
    /// `&T` ã£ã¦ã„ã†ã®ã¯ã€Œå‚ç…§ã€ã ã‚ˆã€‚ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œã‚‰ãšã«ã€ãƒ‡ãƒ¼ã‚¿ãã®ã‚‚ã®ã‚’æŒ‡ã—ç¤ºã™ã‚“ã ã€‚
    /// ã“ã‚Œã§åŠ¹ç‡çš„ã«ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆï¼ğŸ’¨
    pub fn get(&self, entity: Entity) -> Option<&T> {
        // HashMap ã® get ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã ã‘ï¼ä¾¿åˆ©ï¼ğŸ‘
        self.components.get(&entity)
    }

    /// ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ã‚ˆï¼(æ›¸ãè¾¼ã¿å¯èƒ½)
    ///
    /// # å¼•æ•°
    /// - `entity`: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å–å¾—ã—ãŸã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ID
    ///
    /// # æˆ»ã‚Šå€¤
    /// - `Some(&mut T)`: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒã£ã¦ã„ã‚Œã°ã€ãã®å¯å¤‰å‚ç…§ã‚’è¿”ã™ã‚ˆã€‚ã“ã‚Œã§ä¸­èº«ã‚’å¤‰æ›´ã§ãã‚‹ï¼âœï¸
    /// - `None`: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒã£ã¦ã„ãªã‘ã‚Œã°ã€None ã‚’è¿”ã™ã‚ˆã€‚
    ///
    /// `&mut T` ã£ã¦ã„ã†ã®ã¯ã€Œå¯å¤‰å‚ç…§ã€ã ã‚ˆã€‚å‚ç…§å…ˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã§ãã‚‹ç‰¹åˆ¥ãªå‚ç…§ãªã‚“ã ï¼
    pub fn get_mut(&mut self, entity: Entity) -> Option<&mut T> {
        // HashMap ã® get_mut ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã ã‘ï¼ã“ã‚Œã‚‚ä¾¿åˆ©ï¼ğŸ’ª
        self.components.get_mut(&entity)
    }

    /// ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã‚ˆï¼
    ///
    /// # å¼•æ•°
    /// - `entity`: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å‰Šé™¤ã—ãŸã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ID
    ///
    /// # æˆ»ã‚Šå€¤
    /// - `Some(T)`: å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã‚ˆã€‚(ã‚‚ã—å¿…è¦ãªã‚‰ä½¿ãˆã‚‹ï¼)
    /// - `None`: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒã£ã¦ã„ãªã‘ã‚Œã°ã€None ã‚’è¿”ã™ã‚ˆã€‚
    pub fn remove(&mut self, entity: Entity) -> Option<T> {
        // HashMap ã® remove ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã ã‘ï¼ğŸ—‘ï¸
        self.components.remove(&entity)
    }

    /// ã“ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆã¨å¯¾å¿œã™ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰
    /// ã‚’é †ç•ªã«å‡¦ç†ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’è¿”ã™ã‚ˆï¼
    ///
    /// ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¼ã£ã¦ã„ã†ã®ã¯ã€è¦ç´ ã‚’ä¸€ã¤ãšã¤é †ç•ªã«å–ã‚Šå‡ºã›ã‚‹ä¾¿åˆ©ãªä»•çµ„ã¿ã ã‚ˆã€‚
    /// for ãƒ«ãƒ¼ãƒ—ã¨ã‹ã§ã‚ˆãä½¿ã†ï¼ğŸ”„
    ///
    /// `(&Entity, &T)` ã®ã‚¿ãƒ—ãƒ«ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’è¿”ã™ã‚ˆã€‚ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
    pub fn iter(&self) -> impl Iterator<Item = (&Entity, &T)> {
        self.components.iter()
    }

    /// ã“ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆã¨å¯¾å¿œã™ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰
    /// ã‚’é †ç•ªã«å‡¦ç†ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’è¿”ã™ã‚ˆï¼(æ›¸ãè¾¼ã¿å¯èƒ½)
    ///
    /// `(&Entity, &mut T)` ã®ã‚¿ãƒ—ãƒ«ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’è¿”ã™ã‚ˆã€‚ï¼ˆæ›¸ãè¾¼ã¿å¯èƒ½ï¼‰
    pub fn iter_mut(&mut self) -> impl Iterator<Item = (&Entity, &mut T)> {
        self.components.iter_mut()
    }

    /// ã“ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒç©ºã‹ã©ã†ã‹ã‚’è¿”ã™ã‚ˆã€‚
    pub fn is_empty(&self) -> bool {
        self.components.is_empty()
    }

    /// ã“ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å«ã¾ã‚Œã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ•°ã‚’è¿”ã™ã‚ˆã€‚
    pub fn len(&self) -> usize {
        self.components.len()
    }
}

// ComponentStorage ã‚‚ Default ãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…ã—ã¦ãŠã“ã†ï¼
// ã“ã‚Œã§ `ComponentStorage::<Position>::default()` ã¿ãŸã„ã«ç°¡å˜ã«åˆæœŸåŒ–ã§ãã‚‹ï¼
impl<T: Component> Default for ComponentStorage<T> {
    fn default() -> Self {
        Self::new() // new() é–¢æ•°ã‚’å‘¼ã¶ã ã‘ï¼
    }
}

// --- ComponentStorage ã®ãƒ†ã‚¹ãƒˆ ---
#[cfg(test)]
mod tests {
    use super::*; // è¦ªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¦ç´ ã‚’ä½¿ã†å®£è¨€
    use crate::entity::EntityManager; // Entity ã‚’ä½œã‚‹ãŸã‚ã« EntityManager ã‚‚ä½¿ã†

    // ãƒ†ã‚¹ãƒˆã§ä½¿ã†ãŸã‚ã®ãƒ€ãƒŸãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®šç¾©ã™ã‚‹ã‚ˆï¼
    // ä½ç½®æƒ…å ±ã‚’è¡¨ã™ Position ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    #[derive(Debug, PartialEq, Clone)] // ãƒ†ã‚¹ãƒˆã§æ¯”è¼ƒã—ãŸã‚Šã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸã‚Šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    struct Position {
        x: f32,
        y: f32,
    }
    // Component ãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…ï¼ ã“ã‚Œã§ Position ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦èªã‚ã‚‰ã‚Œã‚‹ï¼ğŸ‰
    impl Component for Position {}

    // ãƒ†ã‚¹ãƒˆã§ä½¿ã†ãŸã‚ã®ãƒ€ãƒŸãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ãã®ï¼’ï¼
    // é€Ÿåº¦æƒ…å ±ã‚’è¡¨ã™ Velocity ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    #[derive(Debug, PartialEq, Clone)]
    struct Velocity {
        dx: f32,
        dy: f32,
    }
    // Component ãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…ï¼
    impl Component for Velocity {}

    #[test]
    fn insert_and_get_component() {
        // EntityManager ã¨ Position ç”¨ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½œã‚‹
        let manager = EntityManager::default();
        let mut storage = ComponentStorage::<Position>::default(); // å‹ã‚’æŒ‡å®šã™ã‚‹ã®ã‚’å¿˜ã‚Œãšã«ï¼

        // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ã„ãã¤ã‹ä½œã‚‹
        let entity1 = manager.create_entity();
        let entity2 = manager.create_entity();

        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹
        let pos1 = Position { x: 10.0, y: 20.0 };
        let pos2 = Position { x: 30.0, y: 40.0 };

        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ ï¼
        storage.insert(entity1, pos1.clone()); // clone() ã§ã‚³ãƒ”ãƒ¼ã—ã¦æ¸¡ã™
        storage.insert(entity2, pos2.clone());

        // ã¡ã‚ƒã‚“ã¨å–å¾—ã§ãã‚‹ã‹ç¢ºèªï¼
        // assert_eq! ã§ä¸­èº«ãŒæœŸå¾…é€šã‚Šã‹æ¯”è¼ƒã™ã‚‹ã‚ˆ
        assert_eq!(storage.get(entity1), Some(&pos1), "ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£1ã®PositionãŒé•ã†ï¼ğŸ˜±");
        assert_eq!(storage.get(entity2), Some(&pos2), "ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£2ã®PositionãŒé•ã†ï¼ğŸ˜±");

        // å­˜åœ¨ã—ãªã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å–å¾—ã—ã‚ˆã†ã¨ã—ãŸã‚‰ None ã«ãªã‚‹ã‹ç¢ºèªï¼
        let entity3 = manager.create_entity();
        assert_eq!(storage.get(entity3), None, "å­˜åœ¨ã—ãªã„ã¯ãšã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¦‹ã¤ã‹ã£ãŸï¼ğŸ‘»");

        println!("ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¿½åŠ ãƒ»å–å¾—ãƒ†ã‚¹ãƒˆã€æˆåŠŸï¼ğŸ‰");
    }

    #[test]
    fn get_mut_component() {
        let manager = EntityManager::default();
        let mut storage = ComponentStorage::<Position>::default();
        let entity1 = manager.create_entity();
        let pos1 = Position { x: 10.0, y: 20.0 };
        storage.insert(entity1, pos1);

        // get_mut ã§å¯å¤‰å‚ç…§ã‚’å–å¾—ã—ã¦ã€ä¸­èº«ã‚’å¤‰æ›´ã—ã¦ã¿ã‚‹ï¼âœï¸
        if let Some(pos_mut) = storage.get_mut(entity1) {
            pos_mut.x = 15.0; // x åº§æ¨™ã‚’å¤‰æ›´ï¼
        } else {
            // ã“ã“ã«æ¥ãŸã‚‰ãƒ†ã‚¹ãƒˆå¤±æ•—ï¼
            panic!("get_mut ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å–å¾—ã§ããªã‹ã£ãŸï¼ğŸ˜­");
        }

        // å¤‰æ›´ãŒåæ˜ ã•ã‚Œã¦ã‚‹ã‹ç¢ºèªï¼
        assert_eq!(storage.get(entity1), Some(&Position { x: 15.0, y: 20.0 }), "ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã¦ãªã„ï¼ğŸ¤”");

        println!("ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¤‰æ›´ãƒ†ã‚¹ãƒˆã€æˆåŠŸï¼ğŸ‰");
    }

    #[test]
    fn remove_component() {
        let manager = EntityManager::default();
        let mut storage = ComponentStorage::<Position>::default();
        let entity1 = manager.create_entity();
        let pos1 = Position { x: 10.0, y: 20.0 };
        storage.insert(entity1, pos1.clone());

        // ã¡ã‚ƒã‚“ã¨å…¥ã£ã¦ã‚‹ã“ã¨ã‚’ç¢ºèª
        assert!(storage.get(entity1).is_some(), "å‰Šé™¤å‰ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ï¼ğŸ¥º");

        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å‰Šé™¤ï¼ğŸ—‘ï¸
        let removed_component = storage.remove(entity1);

        // å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ­£ã—ã„ã‹ç¢ºèª
        assert_eq!(removed_component, Some(pos1), "å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒé•ã†ï¼ğŸ¤”");

        // å‰Šé™¤å¾Œã« get ã—ãŸã‚‰ None ã«ãªã‚‹ã‹ç¢ºèª
        assert!(storage.get(entity1).is_none(), "å‰Šé™¤ã—ãŸã¯ãšã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã¾ã æ®‹ã£ã¦ã‚‹ï¼ğŸ˜±");

        println!("ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‰Šé™¤ãƒ†ã‚¹ãƒˆã€æˆåŠŸï¼ğŸ‰");
    }

     #[test]
    fn iter_components() {
        let manager = EntityManager::default();
        let mut storage = ComponentStorage::<Position>::default();

        let entity1 = manager.create_entity();
        let pos1 = Position { x: 1.0, y: 2.0 };
        storage.insert(entity1, pos1.clone());

        let entity2 = manager.create_entity();
        let pos2 = Position { x: 3.0, y: 4.0 };
        storage.insert(entity2, pos2.clone());

        // iter() ã‚’ä½¿ã£ã¦ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼
        let mut count = 0;
        for (entity, pos) in storage.iter() {
            // ã¡ã‚ƒã‚“ã¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒšã‚¢ãŒå–ã‚Œã‚‹ã‹ç¢ºèª
            if *entity == entity1 {
                assert_eq!(pos, &pos1);
            } else if *entity == entity2 {
                assert_eq!(pos, &pos2);
            } else {
                panic!("çŸ¥ã‚‰ãªã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒå‡ºã¦ããŸï¼ğŸ¤¯");
            }
            count += 1;
        }
        // ã¡ã‚ƒã‚“ã¨2ã¤ã®è¦ç´ ãŒå‡¦ç†ã•ã‚ŒãŸã‹ç¢ºèª
        assert_eq!(count, 2, "ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®è¦ç´ æ•°ãŒé•ã†ï¼ğŸ¤”");

        println!("ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ†ã‚¹ãƒˆã€æˆåŠŸï¼ğŸ‰");
    }

    #[test]
    fn different_component_types() {
        // é•ã†ç¨®é¡ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚ã¡ã‚ƒã‚“ã¨å‹•ãã‹ç¢ºèªï¼
        let manager = EntityManager::default();
        let mut pos_storage = ComponentStorage::<Position>::default();
        let mut vel_storage = ComponentStorage::<Velocity>::default(); // Velocity ç”¨ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼

        let entity1 = manager.create_entity();
        let pos1 = Position { x: 1.0, y: 1.0 };
        let vel1 = Velocity { dx: 0.1, dy: 0.0 };

        pos_storage.insert(entity1, pos1.clone());
        vel_storage.insert(entity1, vel1.clone());

        let entity2 = manager.create_entity();
        let pos2 = Position { x: 5.0, y: 5.0 };
        // entity2 ã«ã¯ Velocity ã¯è¿½åŠ ã—ãªã„

        pos_storage.insert(entity2, pos2.clone());

        // ãã‚Œãã‚Œã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æ­£ã—ãå–å¾—ã§ãã‚‹ã‹ï¼Ÿ
        assert_eq!(pos_storage.get(entity1), Some(&pos1));
        assert_eq!(vel_storage.get(entity1), Some(&vel1));
        assert_eq!(pos_storage.get(entity2), Some(&pos2));
        assert_eq!(vel_storage.get(entity2), None); // entity2 ã« Velocity ã¯ãªã„ã¯ãšï¼

        println!("è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã®ãƒ†ã‚¹ãƒˆã€æˆåŠŸï¼ğŸ‰");
    }
} 